---
title: "Interactive Map of Waste Locations of Interest"
scctemplate:
  header:
    site_branding: "Suffolk County Council"
  navigation:
    breadcrumb_trail:
      - text: " Interactive Map of Waste Locations of Interest"
  seo:
    description: "SEO (search engine optimisation) description"
    keywords: "SEO, keywords, comma, separated"
toc: false
---
```{r setup, include = FALSE}
library(sf)
library(leaflet)
library(htmltools)
library(htmlwidgets)
library(mapview)
library(leafem)
library(gt)
library(leaflet.extras)
```

This interactive map displays all Waste Sites, Mineral Extraction Sites and Anglian Water sites in Suffolk.

For Anglian Water Sites, the site boundaries were not available. Therefore these sites are displayed as points only.

Hover over each sites to get information on the name, operator and type of sites. Individual sites can be searched for by clicking on the lens icon. 

You can display this map full screen with the rectangle icon.

In the bottom right, you can change the map background, and tick different boxes to include/exclude different types of sites.

```{r map, echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%", fig.align='center'}
waste_dir <- "L:\\MAPINFO\\DATA\\data_new\\minerals and waste\\Minerals and Waste GIS\\"

# Mineral Consulation Area
consultation_area <- st_read(paste0(waste_dir, "Minerals Consultation Area.TAB"), drivers = "MapInfo File", quiet = TRUE)
consultation_area <- st_transform(consultation_area, 4326)

# waste sites
site_types <- list.files(waste_dir, "*.TAB", recursive = TRUE)

site_types <- site_types[!grepl("combined", site_types)]
site_types <- site_types[!grepl("Buffer", site_types)]
site_types <- site_types[!grepl("Minerals Consultation Area", site_types)]

sites <- lapply(site_types, function(names) {
  sites <- st_read(paste0(waste_dir, names), quiet = TRUE)
  sites$type <- names
  return(sites)
})

sites <- dplyr::bind_rows(sites)

sites$type <- gsub(".TAB", "", sites$type)
sites$type <- gsub("2", "", sites$type)
sites$type <- gsub("1", "", sites$type)
sites$type <- gsub("_", "", sites$type)
sites$type <- gsub("Miscillaneous", "Miscellaneous", sites$type)
sites$type <- gsub("Secondary Aggregate Recycling Sites", "Secondary Aggregate Recycling", sites$type)

# Remove recursive folder names
sites$type <- regmatches(sites$type, gregexpr("(?<=/).*", sites$type, perl=TRUE))

# Adding in anglian water sites
aw_sites <- readr::read_csv("C://Documents//ad-sites//anglian_water_sites.csv")
aw_sites$type <- "Anglian Water Site"

colnames(aw_sites) <- c("Site_Ref", "Site_Name", "Operator", "Easting", "Northing", "type")
aw_sites <- st_as_sf(aw_sites, coords = c("Easting", "Northing"), crs = 27700)

# Convert to osgb, we need 1km buffer
# st_buffer needs to be used in the units of st_crs(x)$units
sites_buffer <- st_buffer(sites, dist = 250)
aw_buffer <- st_buffer(aw_sites, dist = 400)

sites_buffer <- st_union(aw_buffer, sites_buffer)

# Combine buffers if they overlap
sites_buffer <- sites_buffer %>% 
  st_union() %>% 
  st_cast('POLYGON')

sites <- st_transform(sites, 4326)
aw_sites <- st_transform(aw_sites, 4326)

sites_buffer <- st_transform(sites_buffer, 4326)

# HTML labels
labels <- sprintf(
  "<strong>%s</strong><br/><strong>%s</strong><br/> %s",
  sites$Site_Name, sites$Operator, sites$type
) %>% lapply(htmltools::HTML)

aw_labels <- sprintf(
  "<strong>%s</strong><br/><strong>%s</strong><br/> %s",
  aw_sites$Site_Name, aw_sites$Operator, aw_sites$type
) %>% lapply(htmltools::HTML)

mineral_map <- leaflet() |> 
  addTiles(group = "Topo") |> 
  addTiles(
    urlTemplate = "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    group = "Satellite"
  ) |> 
  leaflet::addPolygons(
    data = sites,
    group = sites$type,
    color = "black",
    opacity = 1,
    weight = 2,
    fillColor = "#e8850c",
    fillOpacity = 0.2,
    highlightOptions = highlightOptions(
      color = "white",
      weight = 4,
      fill = "#666",
      fillOpacity = 0.7,
      bringToFront = TRUE
    ),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weigth" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
  ) |> 
  leaflet::addCircles(
    data = aw_sites,
    group = aw_sites$type,
    color = "black",
    opacity = 1,
    weight = 2,
    fillColor = "#2d6ca2",
    fillOpacity = 0.2,
    highlightOptions = highlightOptions(
      color = "white",
      weight = 4,
      fill = "#666",
      fillOpacity = 0.7,
      bringToFront = TRUE
    ),
    label = aw_labels,
    labelOptions = labelOptions(
      style = list("font-weigth" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto"
    ),
  ) |> 
  leaflet::addPolygons(
    data = sites_buffer,
    color = "black",
    opacity = 1,
    weight = 2,
    fill = FALSE,
    group = "Buffers"
  ) |> 
  leaflet::addPolygons(
    data = consultation_area,
    color = "black",
    opacity = 1,
    weight = 2,
    fill = "#666",
    fillOpacity = 0.1,
    group = "Consultation Area"
  ) |> 
  addLayersControl(
    data = sites,
    baseGroups = c("Topo", "Satellite"),
    overlayGroups = c("Consultation Area", "Buffers", aw_sites$type, sites$type),
    position = "bottomright"
  ) |> 
  addLegend(
    colors = c("#e8850c", "#2d6ca2", "#666"),
    labels = c("Waste Sites/Mineral Extraction Sites", "Anglian Water Sites", "Consultation Area")
  ) |>
  addSearchFeatures(
    targetGroups = c(sites$type, aw_sites$type),
    options = searchFeaturesOptions(
      hideMarkerOnCollapse = TRUE
    )) |> 
  addFullscreenControl()

mineral_map
```

## Full list of sites

Below is the full list of sites mapped above.

### Anglian Water Sites

```{r aw_sites, echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%", fig.align='center'}

aw_sites |> 
  gt()

```

### Waste Sites 

```{r waste_sites, echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%", fig.align='center'}

display_sites <- sites |> 
  as.data.frame() |> 
  dplyr::select(type, Site_Ref, Site_Name, Operator, Easting, Northing)

display_sites |> 
  gt()

```

# Reference

All information above was extracted from the [Suffolk Minerals and Waste Plan](https://www.suffolk.gov.uk/planning-waste-and-environment/minerals-and-waste-policy/suffolk-minerals-and-waste-development-scheme/) adopted in July 2020.
